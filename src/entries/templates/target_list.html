{% extends 'competition_index.html' %}

{% block scripts %}
<script src="{{ STATIC_URL }}js/mootools-core-1.3.js"></script>
<script>
    Object.append(Element.NativeEvents, {
        dragstart: 2, dragenter: 2, dragleave: 2, dragover: 2, dragend: 2, drop: 2
    });
    window.addEvent('domready', function () {
        $$('.session-select a').addEvent('click', function (e) {
            e.stop();
            // do this row
            $$('.session-select .link').removeClass('selected');
            this.getElement('.link').addClass('selected');
            // do the round select row
            $$('.round-select').removeClass('selected');
            var newRoundSelect = $$(this.get('href'));
            newRoundSelect.addClass('selected');
            newRoundSelect.getElement('.selected').getParent('a').fireEvent('click');
        });

        $$('.round-select a').addEvent('click', function (e) {
            if (e) {e.stop();}
            // do this row
            this.getParent('.round-select').getElements('.link').removeClass('selected');
            this.getElement('.link').addClass('selected');
            // do the generator
            var board = $$(this.get('href'));
            $$('.target-list-gen').removeClass('selected');
            board.addClass('selected');
        });

        var draggingItem = undefined
        $$('.archer').addEvent('dragstart', function (e) {
            draggingItem = this;
        });

        $$('.archer').addEvent('dragend', function (e) {
            draggingItem = undefined;
            draggingItemSrc = undefined
        });

        $$('.detail').addEvent('dragenter', function (e) {
            this.addClass('drag-over');
        });

        $$('.detail').addEvent('dragleave', function (e) {
            this.removeClass('drag-over');
        });

        $$('.detail').addEvent('dragover', function (e) {
            e.stop();
        });

        $$('.detail').addEvent('drop', function (e) {
            this.removeClass('drag-over');
            var current = this.getElement('.archer');
            var targetBlank = this.getElement('.archer').hasClass('blank');
            var movingOnBoard = draggingItem.getParent('.detail');
            if (!targetBlank && !movingOnBoard) {
                $$('.unallocated')[0].adopt(current);
            }
            if (targetBlank && movingOnBoard)  {
                var archer = new Element('div', {'class': 'archer blank'});
                var name = new Element('p', {'class': 'name', html: '-'});
                archer.adopt(name);
                draggingItem.getParent('.detail').grab(archer, 'top');
            }
            if (!targetBlank && movingOnBoard) {
                movingOnBoard.adopt(current);
            }
            this.empty();
            this.adopt(draggingItem);
        });

        $$('.unallocated').addEvent('dragover', function (e) {
            if (!draggingItem.getParent('.unallocated')) {
                e.stop();
            }
        });

        $$('.unallocated').addEvent('drop', function (e) {
            var archer = new Element('div', {'class': 'archer blank'});
            var name = new Element('p', {'class': 'name', html: '-'});
            archer.adopt(name);
            draggingItem.getParent('.detail').grab(archer, 'top');
            this.adopt(draggingItem);
        });
    });
</script>
{% endblock scripts %}

{% block competition_content %}
<div class="target-list module">
    <h4>Target Lists</h4>
    <div class="target-list-nav">
        <div class="session-select">
            {% for session, rounds in sessions %}
            <a href="#session-{{ session.pk }}"><div class="link {% if not forloop.counter0 %}selected{% endif %}" style="width: 50%">{{ session.start }}</div></a>
            {% endfor %}
        </div>
        <div class="clear"></div>

        {% for session, rounds in sessions %}
        <div class="round-select {% if not forloop.counter0 %}selected{% endif %}" id="session-{{ session.pk }}">
            {% for round in rounds %}
            <a href="#session-{{ session.pk }}-round-{{ round.pk }}"><div class="link {% if not forloop.counter0 %}selected{% endif %}" style="width: 50%">{{ round.shot_round }}</div></a>
            {% endfor %}
        </div>
        <div class="clear"></div>
        {% endfor %}
    </div>

    {% for session, round, targets, entries in target_list %}
    <div class="target-list-gen {% if not forloop.counter0 %}selected{% endif %}" id="session-{{ session.pk }}-round-{{ round.pk }}">
        <div class="board-wrapper">
            <div class="board">
                {% for target, detail in targets %}
                <div class="target">
                    <div class="number"><p>{{ target }}</p></div>
                    <div class="detail">
                        <div class="archer {% if not detail %}blank{% endif %}">
                            {% if detail %}
                            <p class="code">{{ detail.session_entry.competition_entry.code }}</p>
                            <p class="name">{{ detail.session_entry.competition_entry.archer }}</p>
                            <p class="club">{{ detail.session_entry.competition_entry.club }}</p>
                            {% else %}
                            <p class="name">-</p>
                            {% endif %}
                            <div class="clear"></div>
                        </div>
                    </div>
                    <div class="clear"></div>
                </div>
                {% endfor %}
                <div class="clear"></div>
            </div>
        </div>
        <div class="entries-wrapper">
            <div class="entries">
                <div class="unallocated">
                    <h5>Unallocated</h5>
                    {% for entry in entries %}
                    <div class="archer" draggable="true">
                        <p class="code">{{ entry.competition_entry.code }}</p>
                        <p class="name">{{ entry.competition_entry.archer }}</p>
                        <p class="club">{{ entry.competition_entry.club }}</p>
                        <div class="clear"></div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <a href="{% url entries.views.target_list_pdf slug=competition.slug %}">Get pdf</a>
        </div>
        <div class="clear"></div>
    </div>
    {% endfor %}
</div>
{% endblock %}
