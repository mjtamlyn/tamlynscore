{% extends 'entries/competition_detail.html' %}

<<<<<<< HEAD
{% block page_id %}entry-list{% endblock %}

{% block scripts %}
<script src="{{ STATIC_URL }}js/mootools-core-1.3.js"></script>
<script src="{{ STATIC_URL }}js/competition_entries.js"></script>
<script>
Elements.from = function(text, excludeScripts){
	if (excludeScripts || excludeScripts == null) text = text.stripScripts();

	var container, match = text.match(/^\s*<(t[dhr]|tbody|tfoot|thead)/i);

	if (match){
		container = new Element('table');
		var tag = match[1].toLowerCase();
		if (['td', 'th', 'tr'].contains(tag)){
			container = new Element('tbody').inject(container);
			if (tag != 'tr') container = new Element('tr').inject(container);
		}
	}

	return (container || new Element('div')).set('html', text).getChildren();
};
</script>
<script>
    window.addEvent('domready', function () {
        var archer, club, bowstyle, gender, age, novice, gnas_no, sessions;
        sessions = [];
        var reset = function () {
            club.reset();
            bowstyle.reset();
            gender.reset();
            age.reset();
            novice.reset();
            for (var i=0; i < sessions.length; i++) {
                sessions[i].reset();
            }
            gnas_no.set('value', '');
            $$('.show-more-details').removeClass('selected');
            $$('.more-details').removeClass('shown');
            if ($('id_b_team')) {
                $('id_b_team').set('checked', '');
            }
            if ($('id_c_team')) {
                $('id_c_team').set('checked', '');
            }
        };
        var fullReset = function () {
            reset();
            $$('.archer-details').removeClass('shown');
            archer.reset();
        };
        archer = new SelectWidget({
            widget: $('archer-widget'),
            blank: 'New Archer',
            callback: function (widget) {
                reset();
                $$('.archer-details').addClass('shown');
                if (widget.is_new) {
                    $$('.show-more-details').fireEvent('click');
                } else {
                    club.setValue(widget.selectedObject.club);
                    bowstyle.setValue(widget.selectedObject.bowstyle);
                    gender.setValue(widget.selectedObject.gender);
                    age.setValue(widget.selectedObject.age);
                    novice.setValue(widget.selectedObject.novice);
                    gnas_no.set('value', widget.selectedObject.gnas_no);
                }
            }
        });
        club = new SelectWidget({
            widget: $('club-widget'),
            blank: 'New Club'
        });
        bowstyle = new ButtonWidget($('bowstyle-widget'));
        gender = new ButtonWidget($('gender-widget'));
        age = new ButtonWidget($('age-widget'));
        novice = new ButtonWidget($('novice-widget'));
        for (var i=0; i < 10; i++) {
            var field = $('session-' + i + '-widget');
            if (field) {
                sessions.push(new ButtonWidget(field));
            }
        }
        gnas_no = $('id_gnas_no');
        $$('.show-more-details').addEvent('click', function () {
            $$('.more-details').toggleClass('shown');
            this.toggleClass('selected');
        });

        var deleteRow = function () {
            data = {
                'pk': this.get('rel'),
                'csrfmiddlewaretoken': $$('input[name=csrfmiddlewaretoken]')[0].value
            };
            var request = new Request({
                data: data,
                method: 'delete',
                onSuccess: function () {
                    tr = this.getParent('tr');
                    tr.getNext('tr').destroy();
                    tr.destroy();
                }.bind(this)
            });
            request.send();
        };

        $$('.save').addEvent('click', function () {
            data = {}
            $$('.new-entry-form input').each(function (item) {
                data[item.name] = item.value;
            });
            $$('.new-entry-form select').each(function (item) {
                data[item.name] = item.value;
            });
            var request = new Request({
                data: data,
                onSuccess: function (response) {
                    fullReset();
                    var row = Elements.from(response);
                    var table = $$('.entries-table tbody');
                    var rows = [];
                    table.getElements('tr').each(function (tr) {
                        rows.push(tr.dispose());
                    });
                    table.adopt(row);
                    row[0].getLast('td').addEvent('click', deleteRow);
                    rows.each(function (row) {
                        table.adopt(row);
                    });
                },
                onFailure: function (response) {
                    console.log(JSON.decode(response.response));
                }
            });
            request.send();
        });

        $$('td:last-child').addEvent('click', deleteRow);
    });
</script>
{% endblock %}

=======
>>>>>>> new-entry-system
{% block competition_content %}
<div class="row">
    <div class="new-entry col3">
        <h4>New Entry</h4>
        <div class="new-entry-form">
            {% csrf_token %}
            {{ form.archer }}
            <div class="archer-details">
                {{ form.sessions }}
                {{ form.bowstyle }}

<<<<<<< HEAD
                <div class="show-more-details button">
                    More options <div class="pointer">&raquo;</div>
                </div>
                <div class="button save">
                    Save
                </div>
                <div class="clear"></div>

                <div class="more-details">
                    {{ form.club }}
                    {{ form.gnas_no }}
                    {{ form.novice }}
                    {{ form.age }}
                    {{ form.gender }}
                    <div>
                    {% if competition.strict_b_teams %}
                        {{ form.b_team.label }} {{ form.b_team }}
                    {% endif %}
                    </div>
                    <div>
                    {% if competition.strict_c_teams %}
                        {{ form.c_team.label }} {{ form.c_team }}
                    {% endif %}
                    </div>
                    <div class="button save">
                        Save
                    </div>
                    <div class="clear"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="stats col3">
        <h4>Entries Summary</h4>
        <ul>
            {% for stat, value in stats %}
            <li>{{ stat }}: {{ value }}</li>
            {% endfor %}
        </ul>
    </div>
    <div class="clear"></div>
</div>

<div class="row">
    <div class="entries-table col6">
        <h3>Existing entries</h3>


        <div class="row">
        {% for entry in entries %}
        <div class="col2">
            <div class="archer-block">
                <div class="name">
                    <p>{{ entry.archer }}</p>
                </div>
                <div class="bottom">
                    <p>
                        {{ entry.team_name }}
                    </p>
                    <p>
                        <span class="pill bowstyle {{ entry.bowstyle|slugify }}">{{ entry.bowstyle }}</span>
                        <span class="pill gender {{ entry.archer.get_gender_display|lower }}">{{ entry.archer.get_gender_display }}</span>
                        {% if competition.has_novices and entry.novice == "N" %}
                        <span class="pill novice">{{ entry.get_novice_display }}</span>
                        {% endif %}
                        {% if competition.has_juniors and entry.age == "J" %}
                        <span class="pill junior">{{ entry.get_age_display }}</span>
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
        {% endfor %}
        </div>










<div class="competition-entries">
    <div class="module">
        <form method="GET" action="" class="search-form">
            <strong>Search:</strong><br>
            {{ search_form }}
        </form>
        <form method="POST" action="{# url 'new_entry' slug=competition.slug #}" class="new-form">
            {% csrf_token %}
            <strong>Add entry:</strong><br>
            {{ new_form }}
        </form>
        <div class="stats">
            {{ entries|length }} entries
        </div>
    </div>
    <table class="entries">
        <thead>
            <tr>
                <th></th>
                <th>Archer</th>
                <th>Details</th>
                {% for session in sessions %}
                <th>{{ session.session.start }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for entry in entries %}
            <tr>
                <td class="actions">
                    <a>Edit</a>
                    <a>Delete</a>
                </td>
                <td>{{ entry.entry.archer }}</td>
                <td class="details">
                    {{ entry.entry.club }}<br>
                    {{ entry.entry.bowstyle }}<br>
                    {% if competition.has_novices %}
                        {{ entry.entry.get_novice_display }}<br>
                    {% endif %}
                    {% if competition.has_juniors %}
                        {{ entry.entry.archer.get_age_display }}<br>
                    {% endif %}
                    {% if entry.entry.guest %}
                        <em>Guest</em><br>
                    {% endif %}
                </td>
                {% for session in sessions %}
                <td>
                    {% for round in session.rounds %}
                        {% for round_pk in entry.rounds %}
                            {% if round_pk == round.pk %}
                                {{ round.shot_round }}
                            {% endif %}
                        {% endfor %}
                    {% endfor %}
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% endblock %}
